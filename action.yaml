name: Install jq
description: |
  Installs a version of jq into the job tool cache using simple shell scripts

branding:
  icon: copy
  color: orange

inputs:
  version:
    required: false
    description: "Version of jq to install."
    default: "1.7.1"
  force:
    required: false
    description: "If 'true', does not check for existing jq installation before continuing."
    default: 'false'

outputs:
  found:
    description: "If 'true', jq was already found on this runner"
    value: "${{ steps.jq-check-unix.outputs.found == 'true' || steps.jq-check-windows.outputs.found == 'true' }}"
  installed:
    description: "If 'true', jq was installed by this action"
    value: "${{ inputs.force == 'true' || steps.jq-check-unix.outputs.found == 'false' || steps.jq-check-windows.outputs.found == 'false' }}"

runs:
  using: composite
  steps:
    - name: Subscription check
      env:
        REPO_PRIVATE: ${{ github.event.repository.private }}
        FORCE_COLOR: "1"
        ACTION_REPOSITORY: ${{ github.action_repository }}
      run: |
        # Maintained Actions banner (GoReleaser-style bullets)
        ESC=$'\033'
        RESET="${ESC}[0m"
        BOLD="${ESC}[1m"
        YELLOW="${ESC}[33m"
        BLUE="${ESC}[94m"   # soft blue dot (like GoReleaser)
        DIM="${ESC}[2m"

        printf "\n"
        printf "${BOLD}${YELLOW}• StepSecurity Maintained Action${RESET}\n"
        printf "  ${BLUE}•${RESET} ${BOLD}Free for public repositories${RESET}\n"
        printf "  ${BLUE}•${RESET} ${BOLD}Private repositories require Enterprise subscription${RESET}\n\n"

        # validate subscription status
        VISIBILITY_UNKNOWN=false

        # Check if repository visibility is unknown
        if [ -z "$REPO_PRIVATE" ]; then
          VISIBILITY_UNKNOWN=true
        fi

        if [ "$REPO_PRIVATE" = "false" ]; then
          echo "Repository is not private, skipping subscription validation."
        else
          API_URL="https://int.api.stepsecurity.io/v1/github/$GITHUB_REPOSITORY/actions/maintained-actions-subscription"
          SERVER_URL="${GITHUB_SERVER_URL:-https://github.com}"

          # Build JSON request body
          JSON_BODY="{\"action\":\"$ACTION_REPOSITORY\""
          if [ "$SERVER_URL" != "https://github.com" ]; then
            JSON_BODY="$JSON_BODY,\"ghes_server\":\"$SERVER_URL\""
          fi
          JSON_BODY="$JSON_BODY}"

          echo "POST $API_URL"
          echo "Body: $JSON_BODY"

          RESPONSE=$(curl --max-time 3 -s -w "%{http_code}" -X POST -H "Content-Type: application/json" -d "$JSON_BODY" "$API_URL" -o /dev/null) || true

          if [ "$RESPONSE" = "403" ]; then
            echo "::error::This StepSecurity maintained action is free for public repositories.%0AThis repository is private and does not currently have a StepSecurity Enterprise subscription enabled, so the action was not executed.%0ALearn more:%0Ahttps://docs.stepsecurity.io/actions/stepsecurity-maintained-actions"
            exit 1
          elif [ "$RESPONSE" != "200" ]; then
            echo "Timeout or API not reachable. Continuing to next step."
          fi
        fi
      shell: bash

    - name: 'Check for jq - Unix-ish'
      id: jq-check-unix
      if: (runner.os == 'Linux' || runner.os == 'macOS')
      shell: sh +e {0}
      # language=sh
      run: |
        _jq_bin="$(which jq)"
        if [ -f "${_jq_bin}" ]; then
          echo "found=true" >> $GITHUB_OUTPUT
        else
          echo "found=false" >> $GITHUB_OUTPUT
        fi

    - name: 'Install jq - Unix-ish sub-1.7'
      if: (runner.os == 'Linux' || runner.os == 'macOS') && (startsWith(inputs.version, '1.5') || startsWith(inputs.version, '1.6')) && (steps.jq-check-unix.outputs.found == 'false' || inputs.force == 'true')
      shell: sh
      env:
        JQ_VERSION: '${{ inputs.version }}'
      # language=sh
      run: ${GITHUB_ACTION_PATH}/scripts/unixish.sh

    - name: 'Install jq - Unix-ish 1.7+'
      if: (runner.os == 'Linux' || runner.os == 'macOS') && (startsWith(inputs.version, '1.7') || startsWith(inputs.version, '1.8')) && (steps.jq-check-unix.outputs.found == 'false' || inputs.force == 'true')
      shell: sh
      env:
        JQ_VERSION: '${{ inputs.version }}'
      # language=sh
      run: ${GITHUB_ACTION_PATH}/scripts/unixish-17.sh

    - name: 'Check for jq - Windows-ish'
      id: jq-check-windows
      if: runner.os == 'Windows'
      shell: powershell
      # language=powershell
      run: |
        if (Get-Command "jq.exe" -ErrorAction SilentlyContinue)
        {
            Add-Content $Env:GITHUB_OUTPUT "found=true"
        }
        else
        {
            Add-Content $Env:GITHUB_OUTPUT "found=false"
        }

    - name: 'Install jq - Windows-ish sub-1.7'
      if: runner.os == 'Windows' && (startsWith(inputs.version, '1.5') || startsWith(inputs.version, '1.6')) && (steps.jq-check-windows.outputs.found == 'false' || inputs.force == 'true')
      shell: powershell
      env:
        JQ_VERSION: '${{ inputs.version }}'
      run: ${{ github.action_path }}\scripts\windowsish.ps1

    - name: 'Install jq - Windows-ish 1.7+'
      if: runner.os == 'Windows' && (startsWith(inputs.version, '1.7') || startsWith(inputs.version, '1.8')) && (steps.jq-check-windows.outputs.found == 'false' || inputs.force == 'true')
      shell: powershell
      env:
        JQ_VERSION: '${{ inputs.version }}'
      run: ${{ github.action_path }}\scripts\windowsish-17.ps1
